name: Generate Artifacts
# yamllint disable-line rule:truthy
on:
    push:
      branches:
        - master
      paths:
        - "src/**"
        - "oscal"
    pull_request:
      types: [opened, synchronize, reopened]
    workflow_dispatch:
      branches:
        - master
        
env:
    HOME_REPO: GSA/fedramp-automation
jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Install cli
      run: npm install oscal -g

    - name: Produce artifacts baselines in all formats
      run: oscal convert -f ./src/content/rev5/baselines/xml -o artifacts/content/rev5/baselines/

    - name: Produce artifacts for ssp
      run: oscal convert -f ./src/content/rev5/templates/ssp/xml -o artifacts/content/rev5/templates/ssp

    - name: Produce artifacts for poam
      run: oscal convert -f ./src/content/rev5/templates/poam/xml -o artifacts/content/rev5/templates/poam

    - name: Produce artifacts for sap
      run: oscal convert -f ./src/content/rev5/templates/sap/xml -o artifacts/content/rev5/templates/sap

    - name: Produce artifacts for sar
      run: oscal convert -f ./src/content/rev5/templates/sar/xml -o artifacts/content/rev5/templates/sar

    - name: Resolve FedRAMP HIGH baseline profile
      run: oscal resolve -f ./src/content/rev5/baselines/xml/FedRAMP_rev5_HIGH-baseline_profile.xml -o ./dist/content/rev5/baselines/xml/FedRAMP_rev5_HIGH-baseline-resolved-profile_catalog.xml

    - name: Resolve FedRAMP MODERATE baseline profile
      run: oscal resolve -f ./src/content/rev5/baselines/xml/FedRAMP_rev5_MODERATE-baseline_profile.xml -o ./dist/content/rev5/baselines/xml/FedRAMP_rev5_MODERATE-baseline-resolved-profile_catalog.xml

    - name: Resolve FedRAMP LOW baseline profile
      run: oscal resolve -f ./src/content/rev5/baselines/xml/FedRAMP_rev5_LOW-baseline_profile.xml -o ./dist/content/rev5/baselines/xml/FedRAMP_rev5_LOW-baseline-resolved-profile_catalog.xml

    - name: Resolve FedRAMP LI-SaaS baseline profile
      run: oscal resolve -f ./src/content/rev5/baselines/xml/FedRAMP_rev5_LI-SaaS-baseline_profile.xml -o ./dist/content/rev5/baselines/xml/FedRAMP_rev5_LI-SaaS-baseline-resolved-profile_catalog.xml

    - name: Convert Profiles to JSON
      run: oscal convert -f ./dist/content/rev5/baselines/xml/ -o ./dist/content/rev5/baselines/json/ -t JSON

    - name: Convert Profiles to YAML
      run: oscal convert -f ./dist/content/rev5/baselines/xml/ -o ./dist/content/rev5/baselines/yaml/ -t YAML

    - name: Validate xml baselines
      run: oscal validate -f ./dist/content/rev5/baselines/xml/ -e fedramp

    - name: Setup SSH key
      # Only do this on GSA/master
      if: github.repository == env.HOME_REPO && github.ref == 'refs/heads/master'
      run: |
        eval "$(ssh-agent -s)"
        ssh-add - <<< "${{ secrets.SSH_PRIVATE_KEY }}"
    - name: Publish Artifacts
      # Only do this on GSA/master
      if: github.repository == env.HOME_REPO && github.ref == 'refs/heads/master'
      uses: stefanzweifel/git-auto-commit-action@v4.4.1
      with:
        repository: git-content
        commit_message: Publishing auto-converted artifacts
        commit_user_name: OSCAL GitHub Actions Bot
        commit_user_email: oscal@nist.gov
        commit_author: OSCAL GitHub Actions Bot <oscal@nist.gov>
    - name: Publish Artifacts
      # If we are not on GSA/master publish to gh-pages to view results
      if: github.repository != env.HOME_REPO && github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        publish_branch: gh-pages
        keep_files: false
